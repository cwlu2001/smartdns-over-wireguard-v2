[![Docker Image Build](https://github.com/cwlu2001/smartdns-over-wireguard-v2/actions/workflows/docker-image.yml/badge.svg)](https://github.com/cwlu2001/smartdns-over-wireguard-v2/actions/workflows/docker-image.yml)

A SmartDNS proxy in VPN tunnel

## Supported Services
- Twitch
- Netflix

## How to use?
### 1. Clone
```
git clone https://github.com/cwlu2001/smartdns-over-wireguard-v2.git
cd smartdns-over-wireguard-v2
```

### 2. Configure wireguard
Install wireguard if needed
```
sudo apt install wireguard
```

#### 2.1 Generate privatekey
```
wg genkey | tee private.key
```

#### 2.2 Generate publickey
```
cat private.key | wg pubkey | tee public.key
```
The `privatekey`/`publickey` can be seen in the stdout and `private.key`/`public.key` files.

#### 2.3 Edit server config
> vim configs/wireguard/wg0.conf

```conf
[Interface]
PrivateKey = <server privatekey>
Address = 10.10.0.254/24
ListenPort = 51820

[Peer]
PublicKey = <peer1 publickey>
# PresharedKey = <peer1 presharedKey>
AllowedIPs = 10.10.0.1/32

[Peer]
PublicKey = <peer2 publickey>
# PresharedKey = <peer2 presharedKey>
AllowedIPs = 10.10.0.2/32
...
```

#### 2.4 Example config for client
```conf
[Interface]
PrivateKey = <peer1 privatekey>
Address = 10.10.0.1/32
DNS = 10.10.0.254

[Peer]
PublicKey = <server publickey>
# PresharedKey = <peer1 presharedKey>
AllowedIPs = 10.10.0.254/32
Endpoint = 1.2.3.4:51820 # server public ip:port
# PersistentKeepalive = 24
```
> If an additional layer of symmetric-key crypto is required (for, say, post-quantum resistance), WireGuard also supports an optional pre-shared key that is mixed into the public key cryptography.
>> A presharedkey can be generated by `wg genpsk`.

> When a peer is behind NAT or a firewall, it might wish to be able to receive incoming packets even when it is not sending any packets. Because NAT and stateful firewalls keep track of "connections", if a peer behind NAT or a firewall wishes to receive incoming packets. When this option is enabled, a keepalive packet is sent to the server endpoint once every *interval* seconds.

### 3. Run
```
sudo docker-compose up -d
```

## References

- https://thekelleys.org.uk/dnsmasq/doc.html
- https://www.wireguard.com/protocol/#key-exchange-and-data-packets
- https://www.wireguard.com/quickstart/#nat-and-firewall-traversal-persistence
- https://github.com/dlundquist/sniproxy
- https://github.com/Seji64/SniDust
